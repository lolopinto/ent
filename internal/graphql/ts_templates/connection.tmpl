{{reserveImport "graphql" "GraphQLSchema" "GraphQLObjectType" "GraphQLInputObjectType" "GraphQLID" "GraphQLString" "GraphQLEnumType" "GraphQLNonNull" "GraphQLList" "GraphQLFloat" "GraphQLInt" "GraphQLBoolean" }}
{{reserveTypeImport "graphql" "GraphQLFieldConfig" "GraphQLFieldConfigMap" "GraphQLResolveInfo" "GraphQLInputFieldConfigMap" }}
{{reserveTypeImport .Package.PackagePath "ID" "RequestContext" }}
{{reserveImport .Package.GraphQLPackagePath "GraphQLTime" "GraphQLEdgeType" "GraphQLConnectionType" "GraphQLEdge" "GraphQLNodeInterface"}}
{{$conn := .Connection}}
{{$baseObj := .BaseObj}}
{{/* import types that we may need e.g. UserType, ContactType, etc */}}
{{ range $conn.Imports -}} 
  {{reserveImport .ImportPath .Import}}
{{ end -}}

{{$viewerInfo := .Config.GetTemplatizedViewer -}}
{{ reserveTypeImportPath $viewerInfo.GetImportPath false -}}
{{$viewerType := $viewerInfo.GetImport -}}

var connType: {{useImport "GraphQLConnectionType"}}<{{useImport "GraphQLObjectType"}}, {{useImport $conn.Edge.TsEdgeQueryEdgeName}},{{useTypeImport $viewerType}}>;

export const {{ $conn.ConnType}} = () => {
{{/* memoizee or something that actually confirms this is run only once is better here but memoizee doesn't work because GraphQLSchema */ -}}
  if (connType === undefined) {
    connType = new {{useImport "GraphQLConnectionType"}}(
    "{{$conn.Edge.GetGraphQLEdgePrefix}}",
    {{ useImport $conn.GraphQLNodeType }},
    {{ $obj := .CustomObject -}}
    {{ if $obj -}}
      {{ range $obj.Imports -}} 
        {{if .ImportPath -}}
          {{reserveImport .ImportPath .Import -}}
        {{end -}}
      {{ end -}}
      {{ range $obj.DefaultImports -}}    
        {{if .ImportPath -}}
          {{reserveDefaultImport .ImportPath .Import -}}
        {{end -}}
      {{ end -}}
      {
        fields: (): {{useTypeImport "GraphQLFieldConfigMap"}}<
          {{useImport "GraphQLEdge"}}<{{useImport $conn.Edge.TsEdgeQueryEdgeName}}>,
          {{useTypeImport "RequestContext"}}<{{useTypeImport $viewerType}}>
        > => ({
          {{ template "field.tmpl" (dict "Base" $baseObj "Node" $obj "NodeInstance" "edge" "ViewerType" $viewerType) -}}
        }),
      },
    {{ end -}}
    );
  } 
  return connType;
};
