{{reserveImport "graphql" "GraphQLSchema" "GraphQLObjectType" "GraphQLInputObjectType" "GraphQLID" "GraphQLString" "GraphQLEnumType" "GraphQLNonNull" "GraphQLList" "GraphQLFloat" "GraphQLInt" "GraphQLFieldConfig" "GraphQLFieldConfigMap" "GraphQLResolveInfo" "GraphQLInputFieldConfigMap" "GraphQLBoolean" }}
{{reserveImport .Package.PackagePath "ID" "RequestContext" }}
{{reserveImport .Package.GraphQLPackagePath "GraphQLTime" "GraphQLNodeInterface" "GraphQLEdgeInterface" "GraphQLConnectionInterface"}}

{{ define "renderArgs"  -}}
  {{if .Args -}}
    {{$dict := . -}}
    {{$base := .Base -}}
    args: {
      {{range $arg := .Args -}}
        {{$arg.Name}}: {
          description: "{{$arg.Description}}",
          {{ range $import := .Imports -}}
            {{ if $base.ForeignImport $import -}}
              {{$ignored := useImport $import -}}
            {{end -}}
          {{ end -}}
          type: {{$arg.FieldType -}},
        },
      {{end -}}
    },
  {{end -}}
{{ end -}}

{{$baseObj := . -}}

{{/* import types that we may need e.g. UserType, ContactType, etc */}}
{{ range $baseObj.Imports -}} 
  {{reserveImport .ImportPath .Type}}
{{ end -}}

{{ range $baseObj.DefaultImports -}} 
  {{reserveDefaultImport .ImportPath .Type}}
{{ end -}}

{{ range $baseObj.TSInterfaces -}}
  {{ range .Extends}}
    {{ if $baseObj.ForeignImport . -}}
      {{$ignored := useImport . -}}
    {{ end -}}
  {{ end -}}
  {{.InterfaceDecl }} {
  {{ range .Fields -}}
    {{$type := .Type -}}
    {{if .UseImport -}}
      {{$type = useImport $type -}}
    {{end -}}
    {{.Name}}: {{$type}};
  {{ end -}}
  }

{{end}}

{{/* these 2 probably need to change */}}
{{/* TODO these definitely need to change now */}}
{{/* node and nodeInstance do not make sense for non-ents e.g. custom types...*/}}
{{$node := useImport .Node -}}
{{$nodeInstance := .NodeInstance -}}

{{ range $gqlNode := .GQLNodes -}}

  export const {{$gqlNode.Type}} = new {{useImport $gqlNode.GQLType}}({
    name: "{{$gqlNode.Node}}",
    {{ if eq $gqlNode.GQLType "GraphQLInputObjectType" -}}
      fields: (): {{useImport "GraphQLInputFieldConfigMap"}} => ({
    {{ else -}}
      fields: (): {{useImport "GraphQLFieldConfigMap"}}<{{$gqlNode.TSType}}, {{useImport "RequestContext"}}> => ({
    {{ end -}}
      {{/* TODO enum support e.g. account status */}} 
      {{ range $field := $gqlNode.Fields -}}
        {{$field.Name}}: {
          {{range $import := $field.AllImports -}}
            {{ if $baseObj.ForeignImport $import.Type -}}
              {{$ignore := useImport $import.Type -}}
            {{end -}}
          {{end -}}
          type: {{$field.FieldType}},
          {{ template "renderArgs" (dict "Base" $baseObj "Args" $field.Args) -}}
          {{if $field.HasResolveFunction -}}
            {{if $field.HasAsyncModifier -}}
              resolve: async({{$nodeInstance}}: {{$gqlNode.TSType}}, args: {}) => {
            {{ else -}}
              resolve: ({{$nodeInstance}}: {{$gqlNode.TSType}}, args: {}) => {
            {{ end -}}
              {{$field.FunctionContents}};
            },
          {{end -}}
        },
      {{end -}}
    }),
    {{if .GQLInterfaces -}}
    interfaces: [
      {{range $interface := .GQLInterfaces -}}
        {{useImport $interface}},
      {{end -}}
    ],
    {{end -}}
  });
  
{{end}}

{{$fieldConfig := .FieldConfig -}}

{{$prefix := printf "const %s" $fieldConfig.Name -}}
{{ if $fieldConfig.Exported -}}
  {{$prefix = printf "export %s" $prefix -}}
{{end -}}


{{ range $import := $fieldConfig.TypeImports -}}
  {{ if $baseObj.ForeignImport $import -}}
    {{ $ignored := useImport $import -}}
  {{ end -}}
{{ end -}}
{{ range $import := $fieldConfig.ArgImports -}}
  {{ if $baseObj.ForeignImport $import -}}
    {{ $ignored := useImport $import -}}
  {{ end -}}
{{ end -}}


{{$prefix}}: {{useImport "GraphQLFieldConfig"}}<
  undefined,
  {{useImport "RequestContext"}},
  {{$fieldConfig.Arg}}
> = {
  type: {{$fieldConfig.FieldType}},
  {{ template "renderArgs" (dict "Base" $baseObj "Args" $fieldConfig.Args) -}}
  {{if $fieldConfig.ReturnTypeHint -}}
    {{ if $fieldConfig.ResolveMethodArg -}}
      resolve: async (_source, {{$fieldConfig.ResolveMethodArg}}, context:{{useImport "RequestContext"}}, _info: {{useImport "GraphQLResolveInfo"}}): {{$fieldConfig.ReturnTypeHint}} => {
    {{ else -}}
      resolve: async (_source, args: {{$fieldConfig.Arg}}, context:{{useImport "RequestContext"}}, _info: {{useImport "GraphQLResolveInfo"}}): {{$fieldConfig.ReturnTypeHint}} => {
    {{end -}}
  {{ else -}}
    {{ if $fieldConfig.ResolveMethodArg -}}
      resolve: async (_source, {{$fieldConfig.ResolveMethodArg}}, context:{{useImport "RequestContext"}}, _info: {{useImport "GraphQLResolveInfo"}}) => {
    {{else -}}
      resolve: async (_source, args: {{$fieldConfig.Arg}}, context:{{useImport "RequestContext"}}, _info: {{useImport "GraphQLResolveInfo"}}) => {
    {{end -}}
  {{ end -}}
    {{range $line := $fieldConfig.FunctionContents -}}
      {{ $line }}
    {{end -}}
  },
};

