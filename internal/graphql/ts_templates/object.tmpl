{{reserveImport "graphql" "GraphQLSchema" "GraphQLObjectType" "GraphQLInputObjectType" "GraphQLID" "GraphQLString" "GraphQLEnumType" "GraphQLNonNull" "GraphQLList" "GraphQLFloat" "GraphQLInt" "GraphQLFieldConfig" "GraphQLFieldConfigMap" "GraphQLResolveInfo" "GraphQLInputFieldConfigMap" "GraphQLBoolean" }}
{{reserveImport .Package.PackagePath "ID" "RequestContext" }}
{{reserveImport .Package.GraphQLPackagePath "GraphQLTime" "GraphQLNodeInterface" "GraphQLEdgeInterface" "GraphQLConnectionInterface" "nodeIDEncoder" "resolveID" "mustDecodeIDFromGQLID" "encodeGQLID" }}

{{$baseObj := . -}}

{{/* import types that we may need e.g. UserType, ContactType, etc */}}
{{ range $baseObj.Imports -}} 
  {{reserveImport .ImportPath .Type}}
{{ end -}}

{{ range $baseObj.DefaultImports -}} 
  {{reserveDefaultImport .ImportPath .Type}}
{{ end -}}

{{ range $baseObj.TSInterfaces -}}
  {{ range .Extends}}
    {{ if $baseObj.ForeignImport . -}}
      {{$ignored := useImport . -}}
    {{ end -}}
  {{ end -}}
  {{.InterfaceDecl }} {
  {{ range .Fields -}}
    {{$type := .Type -}}
    {{if .UseImport -}}
      {{$type = useImport $type -}}
    {{end -}}
    {{.Name}}: {{$type}};
  {{ end -}}
  }

{{end}}

{{/* these 2 probably need to change */}}
{{/* TODO these definitely need to change now */}}
{{/* node and nodeInstance do not make sense for non-ents e.g. custom types...*/}}
{{$node := useImport .Node -}}
{{$nodeInstance := .NodeInstance -}}

{{ range $gqlNode := .GQLNodes -}}

  export const {{$gqlNode.Type}} = new {{useImport $gqlNode.GQLType}}({
    name: "{{$gqlNode.Node}}",
    {{ if eq $gqlNode.GQLType "GraphQLInputObjectType" -}}
      fields: (): {{useImport "GraphQLInputFieldConfigMap"}} => ({
    {{ else -}}
      fields: (): {{useImport "GraphQLFieldConfigMap"}}<{{$gqlNode.TSType}}, {{useImport "RequestContext"}}> => ({
    {{ end -}}
      {{/* TODO enum support e.g. account status */}} 
      {{ range $field := $gqlNode.Fields -}}
        {{$field.Name}}: {
          {{range $import := $field.AllImports -}}
            {{ if $baseObj.ForeignImport $import.Type -}}
              {{$ignore := useImport $import.Type -}}
            {{end -}}
          {{end -}}
          type: {{$field.FieldType}},
          {{ template "render_args.tmpl" (dict "Base" $baseObj "Args" $field.Args) -}}
          {{if $field.ResolverMethod -}}
            {{ if $baseObj.ForeignImport $field.ResolverMethod -}}
              {{ $ignore := useImport $field.ResolverMethod -}}
            {{end -}}
            resolve: {{useImport $field.ResolverMethod}},
          {{else if $field.HasResolveFunction -}}
            {{if $field.HasAsyncModifier -}}
              resolve: async({{$nodeInstance}}: {{$gqlNode.TSType}}, args: {}) => {
            {{ else -}}
              resolve: ({{$nodeInstance}}: {{$gqlNode.TSType}}, args: {}) => {
            {{ end -}}
              {{$field.FunctionContents}};
            },
          {{end -}}
        },
      {{end -}}
    }),
    {{if .GQLInterfaces -}}
    interfaces: [
      {{range $interface := .GQLInterfaces -}}
        {{useImport $interface}},
      {{end -}}
    ],
    {{end -}}
    {{if .IsTypeOfMethod -}}
      isTypeOf(obj) {
        {{ range $line := .IsTypeOfMethod -}}
          {{$line}}
        {{ end -}}
      },
    {{end -}}
  });
  
{{end}}

{{ if .FieldConfig}}
  {{ template "field_config.tmpl" (dict "Base" $baseObj "FieldConfig" .FieldConfig) -}}
{{ end -}}
